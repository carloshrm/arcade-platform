@inject IConfiguration appConfig
@inject IJSRuntime jsRuntime
@using Blazor.Extensions
@using Blazor.Extensions.Canvas.Canvas2D
@implements IDisposable

<BECanvas Width="@componentWidth" Height="@componentHeight" @ref="_componentReference" />

@code {
    [Parameter] public AppID appID { get; set; }

    private BECanvasComponent? _componentReference { get; set; }
    public Canvas2DContext? canvasReference { get; set; }

    public int componentWidth { get; set; }
    public int componentHeight { get; set; }
    public long windowWidth { get; set; }
    public long windowHeight { get; set; }
    public (int r, int c) baseResolution { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            canvasReference = await _componentReference.CreateCanvas2DAsync();
        }
    }

    protected override void OnInitialized()
    {
        readConfigValues();
    }

    private void readConfigValues()
    {
        foreach (var setting in appConfig.GetSection("games").GetChildren())
        {
            if (setting.GetValue<AppID>("id") == appID)
            {
                baseResolution = (
                    setting.GetValue<int>("size:width"), 
                    setting.GetValue<int>("size:height"));
                break;
            }
        }
    }

    public async Task setCanvasSize()
    {
        windowWidth = await jsRuntime.InvokeAsync<long>("getWindowWidth");
        windowHeight = await jsRuntime.InvokeAsync<long>("getWindowHeight");

        if (appID == AppID.Snake)
        {
            int width = (int)(windowWidth * 0.080) * 10;
            int height = (int)(windowHeight * 0.080) * 10;

            if (height <= width)
            {
                componentWidth = height - (height % baseResolution.c);
                componentHeight = height - (height % baseResolution.r);
            }
            else
            {
                componentWidth = width - (width % baseResolution.c);
                componentHeight = width - (width % baseResolution.r);
            }
        }
        else if (appID == AppID.Invaders)
        {
            (componentWidth, componentHeight) = baseResolution;
        }
        StateHasChanged();
    }

    public async Task clear()
    {
        await canvasReference.ClearRectAsync(0, 0, _componentReference.Width, _componentReference.Height);
    }

    public (int, int) getDimensions()
    {
        return (componentHeight, componentWidth);
    }

    public (int, int) getScreenSize()
    {
        return ((int)windowWidth, (int)windowHeight);
    }

    public void Dispose()
    {
        canvasReference?.Dispose();
    }
}
